image: microsoft/dotnet:latest

stages:
    - build

variables:
    test: "Example.Test"

before_script:
    - "dotnet restore src/Core"

build:
    stage: build
    script:
        - "dotnet build -c Release src/Core/OctoPlus.sln"
        - "dotnet publish -c Release src/Core/OctoPlus.Console/OctoPlus.Console.csproj -o ../../../octoplus-release"
    artifacts:
        paths:
            - octoplus-release/

publish:
    stage: build
    only: 
        - master
    script:
        - apt-get install curl gnupg apt-transport-https
        - curl https://packages.microsoft.com/keys/microsoft.asc | apt-key add -
        - sh -c 'echo "deb [arch=amd64] https://packages.microsoft.com/repos/microsoft-debian-stretch-prod stretch main" > /etc/apt/sources.list.d/microsoft.list'
        - apt-get update
        - apt-get install -y powershell
        - pwsh -File "src/Core/package.ps1 '-nugetKey $NUGETKEY'"